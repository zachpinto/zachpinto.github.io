<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>NYC Restaurant Inspections (Leaflet)</title>
  <!-- Leaflet CSS -->
  <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css"
     integrity="sha256-p4NxAoJBhIIN+hmNHrzRCf9tD/miZyoHS5obTRR9BMY="
     crossorigin=""/>
  <!-- PapaParse for CSV -->
  <script src="https://cdnjs.cloudflare.com/ajax/libs/PapaParse/5.4.1/papaparse.min.js"></script>
  <!-- Your site's CSS -->
  <link rel="stylesheet" href="../../../../monospace.css">
  <style>
    html, body { height: 100%; margin: 0; padding: 0; font-family: sans-serif; } /* Added font */
    h1 {
      position: fixed; /* Keep title fixed */
      top: 0; left: 0; right: 0;
      margin: 0; padding: 1em;
      background: #f5f5f5; /* Match previous style */
      font-size: 1.25em;
      z-index: 1001; /* Ensure title is above map controls */
      box-shadow: 0 2px 4px rgba(0,0,0,0.1); /* Optional: subtle shadow */
    }
    #map-container { /* New container to manage layout */
        position: absolute;
        top: 60px; /* Adjust based on h1 height + padding */
        bottom: 0;
        left: 0;
        right: 0;
        display: flex;
    }
    #map {
        height: 100%;
        width: 70%; /* Adjust width split */
        border-right: 1px solid #ccc; /* Separator */
    }
    #info {
        height: 100%;
        width: 30%; /* Adjust width split */
        padding: 1em;
        overflow-y: auto;
        background: #fff;
        box-sizing: border-box; /* Include padding in width */
    }
    #info h3, #info h4 { margin-top: 0; }
    #info button {
        padding: 8px 15px;
        background-color: #007bff;
        color: white;
        border: none;
        border-radius: 4px;
        cursor: pointer;
        margin-top: 1em;
        display: block;
    }
    #info button:hover {
        background-color: #0056b3;
    }
    .leaflet-popup-content-wrapper {
        background: #f9f9f9;
        border-radius: 4px;
        box-shadow: 0 1px 3px rgba(0,0,0,0.2);
    }
    .leaflet-popup-content p {
        margin: 0.5em 0;
    }
    .leaflet-tooltip {
        background-color: rgba(0, 0, 0, 0.7);
        color: white;
        border: none;
        border-radius: 3px;
        padding: 3px 6px;
        font-size: 0.9em;
    }
  </style>
</head>
<body>
  <h1>NYC Restaurant Inspections</h1>

  <div id="map-container">
      <div id="map"></div>
      <div id="info"><p>Loading map data...</p></div>
  </div>

  <!-- Leaflet JS (after map div) -->
  <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"
     integrity="sha256-20nQCchB9co0qIjJZRGuk2/Z9VM+kNiyxNV1lvTlZBo="
     crossorigin=""></script>

  <script>
    const map = L.map('map').setView([40.7128, -74.0060], 11); // Centered on NYC

    L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
      maxZoom: 19,
      attribution: '&copy; <a href="http://www.openstreetmap.org/copyright">OpenStreetMap</a> contributors'
    }).addTo(map);

    const infoPanel = document.getElementById('info');
    let neighborhoodsLayer = null;
    let inspectionMarkers = L.layerGroup().addTo(map); // Layer group for markers
    let allInspectionsData = []; // To store raw inspection data for filtering
    let ntaDataMap = new Map(); // To store NTA properties (like name) keyed by NTA code

    // --- Helper Functions ---
    function styleNeighborhood(feature) {
        return {
            fillColor: '#cccccc', // Lighter fill
            weight: 1,
            opacity: 1,
            color: '#666666', // Darker border
            fillOpacity: 0.2
        };
    }

    function highlightFeature(e) {
        const layer = e.target;
        layer.setStyle({
            weight: 3,
            color: '#333', // Darker highlight border
            fillOpacity: 0.5 // More opaque fill on hover
        });
        if (!L.Browser.ie && !L.Browser.opera && !L.Browser.edge) {
            layer.bringToFront();
        }
    }

    function resetHighlight(e) {
        if (neighborhoodsLayer) {
            neighborhoodsLayer.resetStyle(e.target);
        }
    }

    function zoomToFeature(e) {
        map.fitBounds(e.target.getBounds());
        const props = e.target.feature.properties;
        const ntaCode = props.nta || props.NTA; // Handle case variations
        const ntaName = props.NTAName || ntaCode || "Selected Area"; // Use name, fallback to code
        filterMarkersByNTA(ntaCode); // Filter markers first
        updateInfoPanelForNeighborhood(ntaName, ntaCode); // Then update panel
    }

    function onEachFeature(feature, layer) {
        // Store NTA details
        const props = feature.properties;
        const ntaCode = props.nta || props.NTA;
        const ntaName = props.NTAName || ntaCode || 'Unknown NTA';
        if (ntaCode && !ntaDataMap.has(ntaCode)) {
            ntaDataMap.set(ntaCode, { name: ntaName });
        }

        layer.on({
            mouseover: highlightFeature,
            mouseout: resetHighlight,
            click: zoomToFeature
        });
        // Add tooltip
        layer.bindTooltip(ntaName, { className: 'leaflet-tooltip' }); // Use custom class
    }

    function filterMarkersByNTA(ntaCode) {
        if (!ntaCode) return;
        inspectionMarkers.clearLayers(); // Clear existing markers
        let count = 0;
        allInspectionsData.forEach(inspection => {
            if (inspection.nta === ntaCode) {
                addMarkerForInspection(inspection);
                count++;
            }
        });
         console.log(`${count} inspections found for NTA: ${ntaCode}`);
    }

    function showAllMarkers() {
        inspectionMarkers.clearLayers();
        allInspectionsData.forEach(addMarkerForInspection);
        map.setView([40.7128, -74.0060], 11); // Reset view
        updateInfoPanelDefault(); // Update panel to default state
    }

    function addMarkerForInspection(inspection) {
        const lat = parseFloat(inspection.latitude);
        const lon = parseFloat(inspection.longitude);
        if (isNaN(lat) || isNaN(lon)) return; // Skip if invalid coords

        const marker = L.circleMarker([lat, lon], {
            radius: 5,
            fillColor: "#d62728", // Red color like before
            color: "#000",
            weight: 1,
            opacity: 1,
            fillOpacity: 0.7
        }).addTo(inspectionMarkers);

        // Popup content
        const popupContent = `
            <h4>${inspection.dba || 'N/A'}</h4>
            <p>${inspection.address || 'N/A'}</p>
            <p><strong>Cuisine:</strong> ${inspection.cuisine_description || 'N/A'}</p>
            <p><strong>Violation:</strong> ${inspection.violation_description || 'N/A'}</p>
            <p><i>NTA: ${inspection.nta || 'N/A'}</i></p>
        `;
        marker.bindPopup(popupContent);

        // Update info panel on marker click
        marker.on('click', () => {
            updateInfoPanelForMarker(inspection);
        });
    }

    // --- Info Panel Updates ---
    function updateInfoPanelDefault() {
        infoPanel.innerHTML = `<h3>Click a marker or neighborhood</h3><p>Showing all ${allInspectionsData.length} inspections.</p><button id="reset-button">Show All Inspections</button>`;
        document.getElementById('reset-button').onclick = showAllMarkers;
    }

    function updateInfoPanelForNeighborhood(ntaName, ntaCode) {
        const markerCount = inspectionMarkers.getLayers().length;
        infoPanel.innerHTML = `
            <h3>Neighborhood: ${ntaName} (${ntaCode})</h3>
            <p>Showing ${markerCount} inspections for this area.</p>
            <button id="reset-button">Show All Inspections</button>
        `;
        document.getElementById('reset-button').onclick = showAllMarkers;
    }

    function updateInfoPanelForMarker(inspection) {
        infoPanel.innerHTML = `
            <h4>${inspection.dba || 'N/A'}</h4>
            <p>${inspection.address || 'N/A'}</p>
            <p><strong>Cuisine:</strong> ${inspection.cuisine_description || 'N/A'}</p>
            <p><strong>Violation:</strong> ${inspection.violation_description || 'N/A'}</p>
            <p><i>NTA: ${inspection.nta || 'N/A'}</i></p>
            <button id="reset-button">Show All Inspections</button>
         `;
         document.getElementById('reset-button').onclick = showAllMarkers;
    }


    // --- Data Loading ---
    async function loadData() {
        try {
            // 1. Load Neighborhoods
            console.log('Fetching neighborhoods.geojson...');
            const geojsonResponse = await fetch('data/neighborhoods.geojson');
            if (!geojsonResponse.ok) throw new Error(`HTTP error loading GeoJSON! Status: ${geojsonResponse.status}`);
            const geojsonData = await geojsonResponse.json();
            console.log('GeoJSON loaded. Adding to map...');

            // Basic GeoJSON validation
            if (!geojsonData || !geojsonData.features) {
                throw new Error('Invalid GeoJSON format: Missing features array.');
            }

            neighborhoodsLayer = L.geoJSON(geojsonData, {
                style: styleNeighborhood,
                onEachFeature: onEachFeature
            }).addTo(map);
            console.log('Neighborhoods layer added.');

            // 2. Load Inspections CSV
            console.log('Parsing inspections_processed.csv...');
            const csvResponse = await new Promise((resolve, reject) => {
                Papa.parse("data/inspections_processed.csv", {
                    download: true,
                    header: true,
                    skipEmptyLines: true,
                    complete: resolve,
                    error: reject
                });
            });

            if (csvResponse.errors.length) {
                console.warn("CSV parsing encountered errors:", csvResponse.errors);
                // Decide if errors are critical. Often PapaParse recovers.
            }
             if (!csvResponse.data || csvResponse.data.length === 0) {
                 throw new Error('No data found in CSV file or failed to parse completely.');
             }

            allInspectionsData = csvResponse.data; // Store all data
            console.log(`Loaded ${allInspectionsData.length} inspections. Adding initial markers...`);
            showAllMarkers(); // Initially show all markers and update panel to default

        } catch (error) {
            console.error("Failed to load data:", error);
            infoPanel.innerHTML = `<p style="color: red; font-weight: bold;">Error loading map data:</p><p style="color: red;">${error.message}</p><p>Please check the file paths and ensure the server is running correctly.</p>`;
        }
    }

    loadData(); // Start loading data when script runs

  </script>
</body>
</html>